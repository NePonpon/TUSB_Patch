TUSB_Spelunker_Patch v1.0.0 仕様をまとめた資料集

0.はじめに
 スぺランカーパッチV2を作成するにあたって必要なスコアやコマンドの知識を、ほとんど忘れている。
そこで、万人が見ても理解できるような資料を書こうと思い立った。

1.パッチ本体

1-1.インストールパッチ
 総文字数28462文字のコマンドを実行。-1924 4 -124 を始点にスぺランカーシステムが構築される。
毎tick実行される列にはコマンドが33コマンド。
プレイヤーが何らかのエンティティに騎乗しているときに実行されるコマンド3コマンド。
ニマス落下検知のコマンド6コマンド。
スぺランカーシステム死亡処理のコマンド12コマンド。
動物処理タグ付与のコマンド12コマンド
MP不足処理のコマンドに1コマンド追加(-1915 8 -177)
祈りkillのコマンドに1コマンド追加(-1916 9 -189)
TypeCheckのコマンドに1コマンド追加(-1880 14 -188)

1-2.有効化パッチ
-1880 14 -188
-1915 8 -177
-1916 9 -189
-1924 4 -125 (未使用 Add-on用)
-1924 4 -124
ゲームルール showDeathMessages の無効

1-3.無効化パッチ
-1880 14 -188
-1915 8 -177
-1916 9 -189
-1924 4 -125 (未使用 Add-on用)
-1924 4 -124
ゲームルール showDeathMessages の有効

1-4.使用スコア
FlyCount	: 空中時間計測用
Damagescore	: ダメージ量取得_stat.damageTaken
SpJump		: ジャンプ検知用_stat.jump
Spkillfrom	: 死亡時ログ表示フラグ
SpBfun		: コウモリのフン落下時間間隔タイマー

1-5.使用タグ
SpRtest		: プレイヤーがエンティティに騎乗しているときに付与
SpfallNK	: 落下死亡処理除外用タグ 浮遊エフェクトをまとっているとき、跳躍スキル、風切スキル実行時付与
SpfINK		: アイテム落下死亡処理除外用タグ 頭のスロットに何か入っていれば付与
SpwNK		: 水中死亡処理除外用タグ 水中呼吸のエフェクトをまとっているとき付与
SpBf		: コウモリのフンになるアイテムについている
SpKILL		: 重複死亡防止タグ 死亡処理を受けたプレイヤーに付与
SpfallkillE	: 落下死重複防止タグ 落下で死亡したプレイヤーに付与
SpA		: 動物接触死亡処理用タグ ほとんどの動物に付与

2.スぺランカーシステム

2-1.1tickごとの処理
エンティティに騎乗しているときにつく{RootVehicle:{}}がついているプレイヤーにタグ：SpRtest付与
  誰かにタグが付いたら<騎乗時処理のコマンド>を実行

全員のタグ：SpfallNkを削除
浮遊エフェクトがついているプレイヤーにSofallNkを付与
スコア：Choyaku(跳躍実行時)が1以上のプレイヤーにタグ：SpfallNkを付与
スコア：Kazakiri(風切実行時)が1以上のプレイヤーにタグ：SpfallNkを付与

全員のタグ：SpfINkを削除
headのスロットに何かアイテムが入っていたらタグ：SpfINkを付与

全員のタグ：SpwNkを削除
浮遊エフェクトがついているプレイヤーにSpwNkを付与
テーブルマウンテン地下水道の村へのワープで水中に出るための対策

{OnGround:0b}で空中にいるプレイヤーを検知
  空中にいるプレイヤーを検知したら<ニマス落下処理のコマンド>を実行

SpwNkを持っていないスぺクテイター以外のプレイヤーの目線の高さに水が来たらスコア：Spkillfromを2にセット

SpKILLを持ってないプレイヤーのスコア：Damagescoreが5以上になったらスコア：Spkillfromを1にセット
Damagescoreは蓄積されるので毎tickリセット

SpAを持つ動物の半径1マス以内にいるSpKILLを持っていないスぺクテイターとクリエイティブ以外のプレイヤーのスコア：Spkillfromを4にセット

WarpOnlyを持っていないコウモリのスコア：SpBfunを1プラスする
SpBfunが40以上になったコウモリからふん(アイテム、タグ：SpBf)を召喚する
ふんからパーティクルを出す
ふんが地面についたらスコア：Spkillfromを99にセット
スコア：Spkillfromが99のエンティティをkill
ふんが水に入ったらkill
スコア：SpBfunが40以上になったら0にセット
ふんの半径1マス以内のSpKILLがついてないクリエイティブ以外のプレイヤーのスコア：Spkillfromを5にセット

それぞれのプレイヤーから半径3マス以上20マス以内のSpBfとSystemEntityを持ってない空中にいるアイテムのスコア：FlyCountを1プラス
SpBfがついてない地面についているアイテムのスコア：FlyCountを-1にセットする
FlyCountが-1のアイテムのFlyCountをリセットする
FlyCountが12以上の1.5マス下が空気のアイテムが半径3マス以内のSpINkを持っていないクリエイティブとスぺクテイター以外のプレイヤーのSpkillfromを6にセット

SpKILLを持ってないスコア：Spkillfromが0以上100以下のプレイヤーをkill
  killしたら<死亡時処理のコマンド>を実行

地面についたらSpfallkillE削除

地面についたらSpKILL削除

2-2.騎乗時処理
タグ：SpRtestがついているプレイヤーに浮遊lv242:4sec付与
  タグ：SpRtestがついているプレイヤーに跳躍力上昇lv128:4sec付与
全員のタグ：SpRtestを削除

2-3.ニマス落下処理
スコア：SpJumpが1以上(ジャンプしたとき)のプレイヤーのスコア：FlyCountを-7にセット
SpfallNkとSpfallkillEがついてない膝もとのブロックが空気の空中にいるプレイヤーのFlyCountを1プラス
FlyCountが5以上の特定の範囲以外の膝もとが空気のSpKILLがついてないプレイヤーのSpkillfromを3にセット
全員のSpJumpをリセット
地面についているプレイヤーのFlyCountをリセット
跳躍lv-128がついているプレイヤーのFlyCountを0にセット

2-3.死亡処理
Spkillfromが0以上100以下のプレイヤーを検知
  Spkillfromが1以上のプレイヤーにタグ：SpKILLを付与
--
Spkillfromが1から7までのプレイヤーそれぞれに死亡ログを流す
  3(ニマス落下死)のみSpfallkillEを付与
--
全員のSpkillfromをリセット
地上にいるプレイヤーのタグ：SpKILLを削除

2-4.MP不足時死
タグ：LackOfMPがついているプレイヤーのSpkillfromを7にセット

2-5.お祈り死
スコア：killが1のプレイヤーに死亡ログを流す

2-6
TypeCheck実行時<動物処理のタグ付与のコマンド>を実行
SpAを持ってない
 豚・羊・牛・タグ：FloatingRequiredを持ってない鶏・イカ・タグ：GimmeBoneを持ってない狼・タグ：WalpOnlyを持ってないコウモリ・CooldownRequiredLongを持ってないヤマネコ・ウサギ・シロクマ・ムーシュルーム
にタグ：SpAを付与
{Saddle:1b}がついている(サドルが付いている)豚からSpAを削除

3.補足解説

3-1.1tickごとの処理
<FlyCountが12以上の1.5マス下が空気のアイテムが半径3マス以内のSpINkを持っていないクリエイティブとスぺクテイター以外のプレイヤーのSpkillfromを6にセット>
-水平移動しているアイテムを除外するために1.5マス下が空気かどうかチェックする


3-2.ニマス落下処理
<FlyCountが5以上の特定の範囲以外の膝もとが空気のSpKILLがついてないプレイヤーのSpkillfromを3にセット>
-はしごを上っているときを除外するために膝もとが空気かどうかチェックする
<跳躍lv-128がついているプレイヤーのFlyCountを0にセット>
-浮遊は「地面についた判定」が付かないから跳躍によって除外する